<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWA Install Test</title>

  <meta name="theme-color" content="#4f46e5" />
  <link rel="manifest" href="manifest.webmanifest?v=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; background:#f6f7fb; color:#222; }
    .box { max-width: 680px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    h1 { margin: 0 0 10px; font-size: 22px; }
    #status { font-size: 14px; color:#555; margin-top: 8px; }
    button { cursor:pointer; border:0; border-radius: 8px; padding: 12px 16px; font-weight: 700; }
    #install { background:#6d28d9; color:#fff; opacity:.6; }
    #install.enabled { opacity:1; }
    .muted { color:#777; font-size: 12px; margin-top: 16px; }
    code { background:#f3f3f7; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="box">
    <h1>PWA Install Test</h1>
    <p>This minimal page verifies the Install prompt works on GitHub Pages.</p>

    <button id="install" disabled>Install App</button>
    <div id="status">Checking files…</div>

    <div class="muted">
      Tips:
      <ul>
        <li>Android (Chrome/Edge/Brave): button enables after one reload when ready.</li>
        <li>iOS (Safari): no prompt; use Share → Add to Home Screen.</li>
        <li>If still disabled, reload once. If it persists, Clear & reset site data and try again.</li>
      </ul>
    </div>
  </div>

  <script>
    (function () {
      const btn = document.getElementById('install');
      const status = document.getElementById('status');
      let deferredPrompt = null;

      const set = (msg) => status.textContent = msg;

      async function check(url, label) {
        try {
          const r = await fetch(url, { cache: 'no-store' });
          if (!r.ok) throw new Error(r.status);
          return true;
        } catch (e) {
          set(`${label} not reachable (${url}). Fix this first.`);
          return false;
        }
      }

      // 1) Quick file checks
      (async () => {
        const okM = await check('manifest.webmanifest?v=1', 'Manifest');
        const okS = await check('sw.js?v=1', 'Service Worker');
        if (!okM || !okS) return;

        set('Files OK. Registering Service Worker…');

        // 2) Register SW (cache-busted, explicit scope)
        if ('serviceWorker' in navigator) {
          try {
            const reg = await navigator.serviceWorker.register('./sw.js?v=1', { scope: './' });
            console.log('[SW] registered:', reg.scope);

            if (!navigator.serviceWorker.controller) {
              set('Service Worker installed. Reload once to let it control the page.');
            } else {
              set('Service Worker is controlling the page. Waiting for install prompt…');
            }

            navigator.serviceWorker.addEventListener('controllerchange', () => {
              set('Service Worker now controls the page. If Install doesn’t appear, wait a moment or reload once more.');
            });
          } catch (e) {
            console.error('[SW] registration failed:', e);
            set('Service Worker registration failed (see console).');
          }
        } else {
          set('This browser does not support Service Workers.');
        }
      })();

      // 3) Install prompt flow
      const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

      if (isStandalone) {
        btn.textContent = 'Installed';
        btn.disabled = true;
        set('App is already installed.');
      } else if (isIos) {
        btn.disabled = false;
        btn.classList.add('enabled');
        btn.textContent = 'How to Install (iOS)';
        set('On iPhone/iPad: use Safari → Share → Add to Home Screen.');
        btn.addEventListener('click', () => {
          alert('On iPhone/iPad: Open in Safari → Share → Add to Home Screen.');
        }, { once: true });
      }

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        btn.disabled = false;
        btn.classList.add('enabled');
        btn.textContent = 'Install App';
        set('Ready. Tap Install App.');
      });

      btn.addEventListener('click', async () => {
        if (!deferredPrompt) {
          if (!navigator.serviceWorker.controller) {
            alert('Almost there! Reload once so the Service Worker can control the page.');
          } else if (!isIos) {
            alert('If no prompt appears, use your browser menu: “Install app”.');
          }
          return;
        }
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('[PWA] userChoice:', outcome);
        deferredPrompt = null;
        if (outcome !== 'accepted') set('Install dismissed. You can use the browser menu to install later.');
      });

      window.addEventListener('appinstalled', () => {
        btn.textContent = 'Installed';
        btn.disabled = true;
        set('Installed successfully.');
      });

      // 4) After a few seconds, guide if nothing happened
      setTimeout(() => {
        if (!deferredPrompt && !isIos && !isStandalone) {
          if (!navigator.serviceWorker.controller) {
            set('Service Worker is not controlling the page yet. Reload once.');
          } else {
            set('Install prompt not available yet. Wait a bit or open the browser menu to Install.');
          }
        }
      }, 4000);
    })();
  </script>
</body>
</html>
