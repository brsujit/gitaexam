<script>
  (function () {
    const installBtn = document.getElementById('installAppBtn');
    const hint = document.getElementById('installHint');
    let deferredPrompt = null;

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('./sw.js');
          console.log('[SW] registered:', reg.scope);

          // Update hint when SW takes control
          if (!navigator.serviceWorker.controller) {
            if (hint) hint.textContent = 'Installed SW. Reload once to enable Install.';
          }
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('[SW] controllerchange');
            if (hint) hint.textContent = 'Ready. If Install doesn’t appear, wait a moment or reload once more.';
          });
        } catch (e) {
          console.error('[SW] registration failed:', e);
          if (hint) hint.textContent = 'SW registration failed (see console).';
        }
      });
    }

    const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    if (installBtn) {
      installBtn.disabled = true;
      if (isStandalone) {
        installBtn.textContent = 'Installed';
        installBtn.disabled = true;
        if (hint) hint.textContent = 'App is already installed.';
      } else if (isIos) {
        installBtn.disabled = false;
        installBtn.textContent = 'How to Install (iOS)';
        if (hint) hint.textContent = 'On iPhone/iPad: Share > Add to Home Screen.';
        installBtn.addEventListener('click', () => {
          alert('On iPhone/iPad: tap the Share icon, then “Add to Home Screen”.');
        }, { once: true });
      }
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (installBtn) {
        installBtn.disabled = false;
        installBtn.textContent = 'Install App';
      }
      if (hint) hint.textContent = 'Tap Install App to add to home screen.';
      console.log('[PWA] beforeinstallprompt fired');
    });

    installBtn?.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        console.log('[PWA] userChoice:', choice.outcome);
        deferredPrompt = null;
        if (choice.outcome !== 'accepted' && hint) {
          hint.textContent = 'Install dismissed. You can try again from the browser menu.';
        }
      } else if (!navigator.serviceWorker.controller) {
        alert('Almost there! Please reload the page once so the app can be installed.');
      } else if (!isIos) {
        alert('If no prompt appears, use your browser menu: “Install app”.');
      }
    });

    window.addEventListener('appinstalled', () => {
      console.log('[PWA] appinstalled');
      if (installBtn) {
        installBtn.textContent = 'Installed';
        installBtn.disabled = true;
      }
      if (hint) hint.textContent = 'App installed successfully.';
    });
  })();
</script>
