<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Sell Bill Book</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#4f46e5">
    <!-- Library for creating Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            body { padding: 0; margin: 0; }
            body * { visibility: hidden; }
            #invoice-print-area, #invoice-print-area * { visibility: visible; }
            #invoice-print-area { box-shadow: none; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Password Protection Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Enter Password</h2>
            <div class="space-y-4">
                <input type="password" id="password-input" class="mt-1 block w-full px-4 py-3 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Password">
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300">
                    Login
                </button>
                <p id="error-message" class="text-red-500 text-sm text-center mt-2 hidden">Incorrect password. Please try again.</p>
            </div>
        </div>
    </div>

    <!-- Main Content (hidden by default) -->
    <div id="main-content" class="hidden p-4 lg:p-8">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- Left Column: Input Form -->
            <div class="lg:col-span-4 bg-white p-6 rounded-xl shadow-lg h-fit no-print">
                <!-- Add Book Details -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Add Book Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="bookSelect" class="block text-sm font-medium text-gray-700">Select a book</label>
                            <select id="bookSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700">Qty</label>
                                <input type="number" id="quantity" value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="rate" class="block text-sm font-medium text-gray-700">Unit Rate (₹)</label>
                                <input type="number" id="rate" value="0" min="0" step="0.01" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none sm:text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bill Options -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Bill Options</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-gray-700">Customer Name</label>
                            <input type="text" id="customerName" placeholder="Walk-in Customer" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>

                        <!-- Address, Country Code, WhatsApp No -->
                        <div>
                            <label for="customerAddress" class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea id="customerAddress" rows="2" placeholder="Street, City, State, PIN" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="countryCode" class="block text-sm font-medium text-gray-700">Country Code</label>
                                <input type="text" id="countryCode" value="91" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., 91">
                            </div>
                            <div>
                                <label for="whatsappNumber" class="block text-sm font-medium text-gray-700">WhatsApp No</label>
                                <input type="text" id="whatsappNumber" inputmode="numeric" pattern="[0-9]*" maxlength="15" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., 8598899371">
                            </div>
                        </div>

                        <div>
                            <label for="amountPaid" class="block text-sm font-medium text-gray-700">Paid Amount (₹)</label>
                            <input type="number" id="amountPaid" value="0" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Actions</h2>
                    <div class="space-y-3">
                        <!-- Add Item button at top of Actions -->
                        <button id="addItemBtn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors duration-300">
                            Add Item to Bill
                        </button>

                        <button id="printBtn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-300">Print/Save/Send</button>
                        <button id="downloadLogBtn" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors duration-300">Download Full Log (Excel)</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Invoice Preview -->
            <div class="lg:col-span-8">
                <div id="invoice-print-area" class="bg-white p-8 print:p-6 rounded-xl shadow-lg">
                    <!-- Invoice Header -->
                    <div class="flex items-center mb-8 print:mb-4 border-b pb-6 print:pb-4 space-x-6">
                        <img src="https://brsujit.github.io/messages/logo/kriya_logo.jpeg" alt="Prajnana Mission Logo" class="h-24 print:h-20 w-auto">
                        <div>
                             <h1 class="text-3xl print:text-2xl font-extrabold text-gray-800 tracking-wider">PRAJNAJNA MISSION</h1>
                             <p class="text-sm text-gray-500 mt-1">Jagatpur, Cuttack - 754021 | Contact Number - +918598899371</p>
                        </div>
                    </div>
                    
                    <!-- Customer & Invoice Details -->
                    <div class="flex justify-between mb-8 print:mb-4 text-sm">
                        <div class="max-w-[65%]">
                            <p class="font-bold text-gray-700">Customer:</p>
                            <p id="invoiceCustomerName" class="text-gray-600">Walk-in Customer</p>

                            <!-- Address (shown only if provided) -->
                            <div id="invoiceAddrBlock" class="mt-2 hidden">
                                <p class="font-bold text-gray-700">Address:</p>
                                <p id="invoiceAddress" class="text-gray-600 whitespace-pre-wrap break-words"></p>
                            </div>

                            <!-- Contact (shown only if provided) -->
                            <div id="invoiceContactBlock" class="mt-2 hidden">
                                <p class="font-bold text-gray-700">Contact:</p>
                                <p id="invoiceContact" class="text-gray-600"></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-700">Invoice No:</p>
                            <p id="invoiceNumber" class="text-gray-600">INV-20251013-001</p>
                            <p class="font-bold text-gray-700 mt-2">Date:</p>
                            <p id="invoiceDate" class="text-gray-600">13/10/2025</p>
                        </div>
                    </div>

                    <!-- Invoice Table -->
                    <div class="min-h-[200px] print:min-h-0">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-100 text-sm font-semibold text-gray-600">
                                    <th class="p-3">#</th>
                                    <th class="p-3 w-2/5">TITLE (AUTHOR)</th>
                                    <th class="p-3 text-center">QTY</th>
                                    <th class="p-3 text-right">RATE (₹)</th>
                                    <th class="p-3 text-right">AMOUNT (₹)</th>
                                    <th class="p-3 text-center no-print">DEL</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems" class="divide-y">
                                <!-- Items will be injected here -->
                                <tr id="empty-message">
                                    <td colspan="6" class="text-center p-16 text-gray-400">Your bill is empty.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Invoice Footer: Totals -->
                    <div class="flex justify-end mt-8 print:mt-4">
                        <div class="w-full md:w-1/2 lg:w-2/5 space-y-3 text-sm">
                            <div class="flex justify-between border-b pb-2 text-base">
                                <span class="font-bold text-gray-800">Total:</span>
                                <span id="total" class="font-bold text-gray-900">₹ 0.00</span>
                            </div>
                            <div class="flex justify-between border-b pb-2 text-base">
                                <span class="font-medium text-green-600">Paid Amount:</span>
                                <span id="paidAmountDisplay" class="font-medium text-green-700">₹ 0.00</span>
                            </div>
                            <div class="flex justify-between bg-yellow-100 p-3 rounded-lg text-lg">
                                <span class="font-bold text-red-600">Due Amount:</span>
                                <span id="dueAmount" class="font-bold text-red-700">₹ 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Placeholder -->
                    <div class="mt-8 print:mt-4">
                        <img src="QRcode.jpg" alt="QR Code" class="w-[200px] h-[320px] print:w-[200px] print:h-[320px]">
                    </div>

                    <!-- Thank you note -->
                    <div class="text-center text-xs print:text-[10px] text-gray-500 mt-8 print:mt-4 pt-6 print:pt-4 border-t">
                         Thank you for your invaluable support and dedication. We are deeply grateful for your efforts. May the choicest blessings of God, Gurus and Bhagavat Gita be upon you always.
                    </div>
                </div>
                 <script>
// PWA: service worker + install prompt
(function () {
  const installAppBtn = document.getElementById('installAppBtn');
  let deferredPrompt = null;

  // Register SW with scope = /gitaexam/ by using a relative path
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    });
  }

  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

  // Initial button state
  if (installAppBtn) {
    installAppBtn.disabled = true;
    if (isStandalone) {
      installAppBtn.textContent = 'Installed';
      installAppBtn.disabled = true;
    }
  }

  window.addEventListener('beforeinstallprompt', (e) => {
    // Chrome fires this when app is installable (needs SW + valid manifest)
    e.preventDefault();
    deferredPrompt = e;
    if (installAppBtn) {
      installAppBtn.disabled = false;
      installAppBtn.textContent = 'Install App';
    }
    console.log('beforeinstallprompt fired');
  });

  if (installAppBtn) {
    installAppBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        console.log('User choice:', choice.outcome);
        deferredPrompt = null;
        // Optionally disable after use:
        // installAppBtn.disabled = true;
      } else {
        // Fallback/help text
        if (isIos && !isStandalone) {
          alert('On iPhone/iPad: tap the Share button, then “Add to Home Screen” to install.');
        } else {
          alert('If the install prompt does not appear, reload once so the service worker can take control. You can also use the browser’s Install option.');
        }
      }
    });
  }

  window.addEventListener('appinstalled', () => {
    console.log('App installed');
    if (installAppBtn) {
      installAppBtn.textContent = 'Installed';
      installAppBtn.disabled = true;
    }
  });
})();
</script>
            // --- PASSWORD PROTECTION ---
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const loginBtn = document.getElementById('login-btn');
            const mainContent = document.getElementById('main-content');
            const errorMessage = document.getElementById('error-message');
            const CORRECT_PASSWORD = 'anirvana';

            loginBtn.addEventListener('click', () => {
                if (passwordInput.value === CORRECT_PASSWORD) {
                    passwordModal.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                } else {
                    errorMessage.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            });
            passwordInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') loginBtn.click(); });
            passwordInput.addEventListener('input', () => { errorMessage.classList.add('hidden'); });

            // --- BOOK DATABASE ---
            const booksDB = [
                { id: 'default', title: 'Select a Book...', author: '', rate: 0 },
                { id: '1', title: 'Shrimad Bhagavat Gita, Chapter-5', author: 'Paramahamsa Prajnanananda', rate: 50.00 },
            ];

            // --- STATE ---
            let billItems = [];
            let salesLogDatabase = [];
            let invoiceCounter = 1;

            // --- STORAGE KEYS ---
            const LOG_STORAGE_KEY = 'pm_billbook_sales_log_v1';
            const INVOICE_COUNTER_KEY = 'pm_billbook_invoice_counter_v1';
            const INVOICE_DATE_KEY = 'pm_billbook_invoice_date_v1';

            // --- DOM ELEMENTS ---
            const bookSelectEl = document.getElementById('bookSelect');
            const quantityEl = document.getElementById('quantity');
            const rateEl = document.getElementById('rate');
            const addItemBtn = document.getElementById('addItemBtn');
            const customerNameEl = document.getElementById('customerName');
            const customerAddressEl = document.getElementById('customerAddress');
            const countryCodeEl = document.getElementById('countryCode');
            const whatsappNumberEl = document.getElementById('whatsappNumber');
            const amountPaidEl = document.getElementById('amountPaid');
            const printBtn = document.getElementById('printBtn');
            const downloadLogBtn = document.getElementById('downloadLogBtn');
            const invoiceCustomerNameEl = document.getElementById('invoiceCustomerName');
            const invoiceNumberEl = document.getElementById('invoiceNumber');
            const invoiceDateEl = document.getElementById('invoiceDate');
            const invoiceItemsEl = document.getElementById('invoiceItems');
            const totalEl = document.getElementById('total');
            const paidAmountDisplayEl = document.getElementById('paidAmountDisplay');
            const dueAmountEl = document.getElementById('dueAmount');
            const invoiceAddrBlock = document.getElementById('invoiceAddrBlock');
            const invoiceAddressEl = document.getElementById('invoiceAddress');
            const invoiceContactBlock = document.getElementById('invoiceContactBlock');
            const invoiceContactEl = document.getElementById('invoiceContact');

            // --- UTILS ---
            const populateBookDropdown = () => {
                booksDB.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = book.title;
                    bookSelectEl.appendChild(option);
                });
            };

            const handleBookSelection = () => {
                const selectedBookId = bookSelectEl.value;
                const selectedBook = booksDB.find(book => book.id === selectedBookId);
                rateEl.value = selectedBook ? selectedBook.rate.toFixed(2) : '0.00';
            };

            const formatCurrency = (amount) => `₹ ${amount.toFixed(2)}`;

            const getFormattedDate = () => {
                const today = new Date();
                const d = String(today.getDate()).padStart(2, '0');
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const y = today.getFullYear();
                return `${d}/${m}/${y}`;
            };

            const getTodayId = () => {
                const t = new Date();
                return `${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}`;
            };
            
            const getInvoiceNumber = () => {
                const today = new Date();
                const d = String(today.getDate()).padStart(2, '0');
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const y = today.getFullYear();
                const count = String(invoiceCounter).padStart(3, '0');
                return `INV-${y}${m}${d}-${count}`;
            };

            const getDisplayPhone = () => {
                const code = (countryCodeEl.value || '').replace(/[^\d]/g, '');
                const num = (whatsappNumberEl.value || '').replace(/[^\d]/g, '');
                if (!num) return '';
                return `+${code || '91'} ${num}`;
            };

            // --- PERSISTENCE HELPERS ---
            const persistSalesLog = () => {
                try { localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(salesLogDatabase)); }
                catch (e) { console.warn('Could not persist sales log:', e); }
            };

            const loadSalesLog = () => {
                try {
                    const raw = localStorage.getItem(LOG_STORAGE_KEY);
                    salesLogDatabase = raw ? JSON.parse(raw) : [];
                } catch (e) {
                    console.warn('Could not load sales log:', e);
                    salesLogDatabase = [];
                }
            };

            const loadInvoiceCounter = () => {
                const todayId = getTodayId();
                const storedDate = localStorage.getItem(INVOICE_DATE_KEY);
                if (storedDate === todayId) {
                    const storedCounter = parseInt(localStorage.getItem(INVOICE_COUNTER_KEY) || '1', 10);
                    invoiceCounter = isNaN(storedCounter) ? 1 : storedCounter;
                } else {
                    invoiceCounter = 1;
                    localStorage.setItem(INVOICE_DATE_KEY, todayId);
                    localStorage.setItem(INVOICE_COUNTER_KEY, String(invoiceCounter));
                }
            };

            // --- RENDER ---
            const renderBill = () => {
                invoiceItemsEl.innerHTML = '';
                const emptyMessageContent = `<tr id="empty-message"><td colspan="6" class="text-center p-16 text-gray-400">Your bill is empty.</td></tr>`;

                if (billItems.length === 0) {
                    invoiceItemsEl.innerHTML = emptyMessageContent;
                } else {
                    billItems.forEach((item, index) => {
                        const tr = document.createElement('tr');
                        tr.className = "text-sm text-gray-700";
                        tr.innerHTML = `
                            <td class="p-3">${index + 1}</td>
                            <td class="p-3">
                                <span class="font-semibold">${item.title}</span>
                                <span class="block text-xs text-gray-500">${item.author}</span>
                            </td>
                            <td class="p-3 text-center">${item.qty}</td>
                            <td class="p-3 text-right">${formatCurrency(item.rate)}</td>
                            <td class="p-3 text-right font-semibold">${formatCurrency(item.amount)}</td>
                            <td class="p-3 text-center no-print">
                                <button class="delete-item-btn text-red-500 hover:text-red-700" data-index="${index}" aria-label="Delete item ${index + 1}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        `;
                        invoiceItemsEl.appendChild(tr);
                    });
                }

                const total = billItems.reduce((acc, item) => acc + item.amount, 0);
                const paidAmount = parseFloat(amountPaidEl.value) || 0;
                const dueAmount = total - paidAmount;
                
                totalEl.textContent = formatCurrency(total);
                paidAmountDisplayEl.textContent = formatCurrency(paidAmount);
                dueAmountEl.textContent = formatCurrency(dueAmount);
                
                // Customer details on invoice
                invoiceCustomerNameEl.textContent = customerNameEl.value || 'Walk-in Customer';
                const addr = (customerAddressEl.value || '').trim();
                const phoneDisp = getDisplayPhone();
                invoiceAddressEl.textContent = addr;
                invoiceAddrBlock.classList.toggle('hidden', !addr);
                invoiceContactEl.textContent = phoneDisp;
                invoiceContactBlock.classList.toggle('hidden', !phoneDisp);
            };

            // --- HANDLERS ---
            const handleAddItem = () => {
                const selectedBookId = bookSelectEl.value;
                const selectedBook = booksDB.find(book => book.id === selectedBookId);
                const qty = parseInt(quantityEl.value, 10);
                const rate = parseFloat(rateEl.value);

                if (!selectedBook || selectedBook.id === 'default' || isNaN(qty) || qty <= 0) {
                    alert('Please select a book and enter a valid quantity.');
                    return;
                }

                billItems.push({
                    title: selectedBook.title,
                    author: selectedBook.author,
                    qty,
                    rate,
                    amount: qty * rate
                });

                bookSelectEl.value = 'default';
                quantityEl.value = '1';
                rateEl.value = '0.00';
                
                renderBill();
            };

            const handleSaveLog = () => {
                if (billItems.length === 0) return;

                const invoiceNo = invoiceNumberEl.textContent;
                const date = invoiceDateEl.textContent;
                const customer = customerNameEl.value || 'Walk-in Customer';
                
                const total = billItems.reduce((acc, item) => acc + item.amount, 0);
                const paid = parseFloat(amountPaidEl.value) || 0;
                const due = total - paid;

                billItems.forEach((item, index) => {
                    salesLogDatabase.push({
                        invoiceNo,
                        date,
                        customer,
                        itemNo: index + 1,
                        title: item.title,
                        author: item.author,
                        qty: item.qty,
                        rate: item.rate,
                        amount: item.amount,
                        total,
                        paidAmount: paid,
                        dueAmount: due
                    });
                });
                persistSalesLog();
                console.log(`Invoice ${invoiceNo} saved to log. Log entries: ${salesLogDatabase.length}`);
            };

            const handleDownloadFullLog = () => {
                if (salesLogDatabase.length === 0) {
                    alert('The sales log is empty. Save an invoice first by printing it.');
                    return;
                }

                const data = [
                    ["Invoice No", "Date", "Customer", "#", "Book Title", "Author", "Qty", "Rate (₹)", "Amount (₹)", "Invoice Total", "Paid Amount", "Due Amount"]
                ];

                salesLogDatabase.forEach(entry => {
                    data.push([
                        entry.invoiceNo,
                        entry.date,
                        entry.customer,
                        entry.itemNo,
                        entry.title,
                        entry.author,
                        entry.qty,
                        entry.rate.toFixed(2),
                        entry.amount.toFixed(2),
                        entry.total.toFixed(2),
                        entry.paidAmount.toFixed(2),
                        entry.dueAmount.toFixed(2)
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "SalesLog");

                const today = new Date();
                const d = String(today.getDate()).padStart(2, '0');
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const y = today.getFullYear();
                const filename = `PrajnanaMission_SalesLog_${y}${m}${d}.xlsx`;
                
                XLSX.writeFile(wb, filename);
            };

            // --- WhatsApp helpers ---
            const buildWhatsAppMessage = () => {
                const invoiceNo = invoiceNumberEl.textContent.trim();
                const date = invoiceDateEl.textContent.trim();
                const customer = (customerNameEl.value || 'Walk-in Customer').trim();
                const address = (customerAddressEl.value || '').trim();
                const contact = getDisplayPhone();

                const itemsLines = billItems.map((item, i) => {
                    const authorPart = item.author ? ` (${item.author})` : '';
                    return `${i + 1}) ${item.title}${authorPart} - ${item.qty} x ₹${item.rate.toFixed(2)} = ₹${item.amount.toFixed(2)}`;
                }).join('\n');

                const total = billItems.reduce((acc, item) => acc + item.amount, 0);
                const paid = parseFloat(amountPaidEl.value) || 0;
                const due = total - paid;

                return `Prajnana Mission Invoice
Invoice No: ${invoiceNo}
Date: ${date}
Customer: ${customer}${address ? `\nAddress: ${address}` : ''}${contact ? `\nContact: ${contact}` : ''}

Items:
${itemsLines || '-'}
-----------------------
Total: ₹${total.toFixed(2)}
Paid: ₹${paid.toFixed(2)}
Due: ₹${due.toFixed(2)}

Thank you for your support.`;
            };

            const getWhatsAppPhone = () => {
                const code = (countryCodeEl.value || '').replace(/[^\d]/g, '');
                const num = (whatsappNumberEl.value || '').replace(/[^\d]/g, '');
                if (!num) return '';
                const finalCode = code || '91';
                return `${finalCode}${num}`;
            };

            const buildWhatsAppURL = (phone, msg) => {
                const enc = encodeURIComponent(msg);
                if (phone) return `https://wa.me/${phone}?text=${enc}`;
                return `https://wa.me/?text=${enc}`;
            };

            const openWhatsAppSafely = (url, waWinHandle) => {
                try {
                    if (waWinHandle && !waWinHandle.closed) {
                        waWinHandle.location = url;
                    } else {
                        window.open(url, '_blank');
                    }
                } catch (e) {
                    console.warn('Fallback open due to popup restriction:', e);
                    window.open(url, '_blank');
                }
            };

            const initialize = () => {
                loadInvoiceCounter();
                invoiceDateEl.textContent = getFormattedDate();
                invoiceNumberEl.textContent = getInvoiceNumber();
            };

            // --- EVENT LISTENERS ---
            addItemBtn.addEventListener('click', handleAddItem);
            downloadLogBtn.addEventListener('click', handleDownloadFullLog);
            bookSelectEl.addEventListener('change', handleBookSelection);

            // Auto-update invoice preview as you type
            customerNameEl.addEventListener('input', renderBill);
            customerAddressEl.addEventListener('input', renderBill);
            countryCodeEl.addEventListener('input', renderBill);
            whatsappNumberEl.addEventListener('input', renderBill);
            amountPaidEl.addEventListener('input', renderBill);
            
            invoiceItemsEl.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-item-btn');
                if (deleteButton) {
                    const indexToDelete = parseInt(deleteButton.dataset.index, 10);
                    billItems.splice(indexToDelete, 1);
                    renderBill();
                }
            });

            // Print/Save/Send combined (no resets)
            printBtn.addEventListener('click', () => {
                if (billItems.length === 0) {
                    alert('Your bill is empty. Please add items before printing/sending.');
                    return;
                }

                // Save to persistent log
                handleSaveLog();

                // Prepare WhatsApp
                const phone = getWhatsAppPhone();
                const msg = buildWhatsAppMessage();
                const waUrl = buildWhatsAppURL(phone, msg);

                // Open a blank tab synchronously to avoid popup blocking
                const waWin = window.open('about:blank', '_blank');

                // After print, redirect the blank tab to WhatsApp (no reset)
                let sentAlready = false;
                const doSend = () => {
                    if (sentAlready) return;
                    sentAlready = true;
                    window.removeEventListener('afterprint', doSend);
                    openWhatsAppSafely(waUrl, waWin);
                };

                window.addEventListener('afterprint', doSend);
                window.print();

                // Fallback for browsers that don't fire 'afterprint'
                setTimeout(doSend, 1500);
            });

            // --- INITIALIZATION ---
            loadSalesLog();
            populateBookDropdown();
            initialize();
            renderBill();
        });
    </script>
</body>

</html>

