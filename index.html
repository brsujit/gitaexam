<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Sell Bill Book</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Prajnana Mission Bill Book","short_name":"Bill Book","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#4f46e5","description":"A simple book billing application.","icons":[{"src":"https://gccgkt.github.io/messages/logo/kriya_logo_192.png","sizes":"192x192","type":"image/png"},{"src":"https://brsujit.github.io/messages/logo/kriya_logo_512.png","sizes":"512x512","type":"image/png"}]}' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            body { padding: 0; margin: 0; }
            body * { visibility: hidden; }
            #invoice-print-area, #invoice-print-area * { visibility: visible; }
            #invoice-print-area { box-shadow: none; }
            .no-print { display: none; }
        }
    </style>
    
    <style>
        :root {
          --primary: #0b5ed7;
          --bg: #f7f9fc;
          --text: #1f2937;
          --card: #ffffff;
          --muted: #6b7280;
          --success: #16a34a;
          --danger: #dc2626;
        }
        .login-card {
          width: 100%;
          max-width: 420px;
          background: var(--card);
          border: 1px solid #e5e7eb;
          border-radius: 14px;
          padding: 20px;
          box-shadow: 0 1px 2px rgba(16, 24, 40, .04);
        }
        .login-card h2 {
          margin: 0 0 6px 0;
          font-size: 20px;
        }
        .sub {
          margin: 0 0 18px 0;
          color: var(--muted);
          font-size: 14px;
        }
        .field { margin-bottom: 12px; }
        .label {
          display: block;
          font-size: 13px;
          margin-bottom: 6px;
          color: #374151;
          font-weight: 600;
        }
        input[type="text"], input[type="password"] {
          width: 100%;
          padding: 12px 14px;
          border: 1px solid #e5e7eb;
          border-radius: 10px;
          font-size: 14px;
          outline: none;
          transition: border-color .2s, box-shadow .2s;
          background: #fff;
        }
        input:focus {
          border-color: #c9ddff;
          box-shadow: 0 0 0 4px rgba(11, 94, 215, .08);
        }
        .row {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          margin: 4px 0 10px;
        }
        .row small {
          color: var(--muted);
          font-size: 12px;
        }
        /* Shared button class */
        button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          padding: 12px 14px;
          border: none;
          border-radius: 10px;
          font-weight: 700;
          cursor: pointer;
          font-size: 14px;
          transition: transform .02s ease, filter .2s;
        }
        button:active { transform: translateY(1px); }
        
        .btn-primary {
          background: var(--primary);
          color: #fff;
          width: 100%;
        }
        /* Added for the install button */
        .btn-secondary {
          background: #eef2ff;
          color: #1e3a8a;
          border: 1px solid #dde7ff;
        }
        .status {
          margin-top: 10px;
          font-size: 13px;
        }
        .status.ok { color: var(--success); }
        .status.err { color: var(--danger); }
        
        /* Added for the install tip */
        .muted {
          color: var(--muted);
          font-size: 13px;
          margin-top: 10px;
          text-align: center;
        }

        /* Added for iOS install sheet */
        .sheet {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,.45);
          display: none;
          align-items: flex-end;
          z-index: 9999;
        }
        .sheet.open { display: flex; }
        .sheet .panel {
          background: #fff;
          width: 100%;
          padding: 18px;
          border-top-left-radius: 16px;
          border-top-right-radius: 16px;
          box-shadow: 0 -8px 30px rgba(0,0,0,.15);
        }
        .sheet h3 { margin: 0 0 6px 0; font-size: 16px; }
        .sheet p { margin: 0 0 10px 0; color: #374151; font-size: 14px; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <section class="login-card" aria-labelledby="login-title">
            <h2 id="login-title">Login</h2>
            <p class="sub">Please enter your password to access the bill book.</p>
    
            <form id="loginForm" novalidate>
                <div class="field">
                    <label class="label" for="password">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required placeholder="Enter your password" />
                </div>
    
                <div class="row">
                    <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#374151;cursor:pointer;">
                        <input id="showPw" type="checkbox" />
                        Show password
                    </label>
                </div>
    
                <button id="loginBtn" class="btn-primary" type="submit">Login</button>
                <div id="status" class="status" role="status" aria-live="polite"></div>
            </form>

            <button id="loginInstallBtn" type="button" class="btn-secondary w-full mt-4" hidden>
                📲 Install in your mobile
            </button>

            <p class="muted">
                Tip: You can install this app on your device for a full-screen, offline-capable experience.
            </p>
        </section>
    </div>
    
    <div id="main-content" class="hidden p-4 lg:p-8">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 bg-white p-6 rounded-xl shadow-lg h-fit no-print">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Add Book Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="bookSelect" class="block text-sm font-medium text-gray-700">Select a book</label>
                            <select id="bookSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700">Qty</label>
                                <input type="number" id="quantity" value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="rate" class="block text-sm font-medium text-gray-700">Unit Rate (₹)</label>
                                <input type="number" id="rate" value="0" min="0" step="0.01" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none sm:text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Bill Options</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-gray-700">Customer Name</label>
                            <input type="text" id="customerName" placeholder="Walk-in Customer" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>

                        <div>
                            <label for="customerAddress" class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea id="customerAddress" rows="2" placeholder="Street, City, State, PIN" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="countryCode" class="block text-sm font-medium text-gray-700">Country Code</label>
                                <input type="text" id="countryCode" value="91" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., 91">
                            </div>
                            <div>
                                <label for="whatsappNumber" class="block text-sm font-medium text-gray-700">WhatsApp No</label>
                                <input type="text" id="whatsappNumber" inputmode="numeric" pattern="[0-9]*" maxlength="15" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., 8598899371">
                            </div>
                        </div>

                        <div>
                            <label for="amountPaid" class="block text-sm font-medium text-gray-700">Paid Amount (₹)</label>
                            <input type="number" id="amountPaid" value="0" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Actions</h2>
                    <div class="space-y-3">
                        <button id="addItemBtn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors duration-300">
                            Add Item to Bill
                        </button>

                        <button id="printBtn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-300">Print/Save/Send</button>
                        <button id="downloadLogBtn" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors duration-300">Download Full Log (Excel)</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div id="invoice-print-area" class="bg-white p-8 print:p-6 rounded-xl shadow-lg">
                    <div class="flex items-center mb-8 print:mb-4 border-b pb-6 print:pb-4 space-x-6">
                        <img src="https://gccgkt.github.io/messages/logo/kriya_logo.jpeg" alt="Prajnana Mission Logo" class="h-24 print:h-20 w-auto">
                        <div>
                             <h1 class="text-3xl print:text-2xl font-extrabold text-gray-800 tracking-wider">PRAJNAJNA MISSION</h1>
                             <p class="text-sm text-gray-500 mt-1">Jagatpur, Cuttack - 754021 | Contact Number - +918598899371</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mb-8 print:mb-4 text-sm">
                        <div class="max-w-[65%]">
                            <p class="font-bold text-gray-700">Customer:</p>
                            <p id="invoiceCustomerName" class="text-gray-600">Walk-in Customer</p>
                            <div id="invoiceAddrBlock" class="mt-2 hidden">
                                <p class="font-bold text-gray-700">Address:</p>
                                <p id="invoiceAddress" class="text-gray-600 whitespace-pre-wrap break-words"></p>
                            </div>
                            <div id="invoiceContactBlock" class="mt-2 hidden">
                                <p class="font-bold text-gray-700">Contact:</p>
                                <p id="invoiceContact" class="text-gray-600"></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-700">Invoice No:</p>
                            <p id="invoiceNumber" class="text-gray-600">INV-20251013-001</p>
                            <p class="font-bold text-gray-700 mt-2">Date:</p>
                            <p id="invoiceDate" class="text-gray-600">13/10/2025</p>
                        </div>
                    </div>

                    <div class="min-h-[200px] print:min-h-0">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-100 text-sm font-semibold text-gray-600">
                                    <th class="p-3">#</th>
                                    <th class="p-3 w-2/f">TITLE (AUTHOR)</th>
                                    <th class="p-3 text-center">QTY</th>
                                    <th class="p-3 text-right">RATE (₹)</th>
                                    <th class="p-3 text-right">AMOUNT (₹)</th>
                                    <th class="p-3 text-center no-print">DEL</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems" class="divide-y">
                                <tr id="empty-message">
                                    <td colspan="6" class="text-center p-16 text-gray-400">Your bill is empty.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-end mt-8 print:mt-4">
                        <div class="w-full md:w-1/2 lg:w-2/5 space-y-3 text-sm">
                            <div class="flex justify-between border-b pb-2 text-base">
                                <span class="font-bold text-gray-800">Total:</span>
                                <span id="total" class="font-bold text-gray-900">₹ 0.00</span>
                            </div>
                            <div class="flex justify-between border-b pb-2 text-base">
                                <span class="font-medium text-green-600">Paid Amount:</span>
                                <span id="paidAmountDisplay" class="font-medium text-green-700">₹ 0.00</span>
                            </div>
                            <div class="flex justify-between bg-yellow-100 p-3 rounded-lg text-lg">
                                <span class="font-bold text-red-600">Due Amount:</span>
                                <span id="dueAmount" class="font-bold text-red-700">₹ 0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 print:mt-4">
                        <img src="QRcode.jpg" alt="QR Code" class="w-[200px] h-[320px] print:w-[200px] print:h-[320px]">
                    </div>

                    <div class="text-center text-xs print:text-[10px] text-gray-500 mt-8 print:mt-4 pt-6 print:pt-4 border-t">
                         Thank you for your invaluable support and dedication. We are deeply grateful for your efforts. May the choicest blessings of God, Gurus and Bhagavat Gita be upon you always.
                    </div>
                </div>
                 <div class="mt-6 text-center no-print">
                    <button id="installAppBtn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Install in your mobile phone
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-2 no-print">Button becomes active if your browser supports installation.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="iosSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="iosTitle" aria-describedby="iosDesc">
        <div class="panel">
            <h3 id="iosTitle">Install on iPhone/iPad</h3>
            <p id="iosDesc">
                1) Tap the Share icon in Safari. 2) Choose “Add to Home Screen”.
            </p>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
                <button type="button" class="btn-secondary" id="closeIos">Close</button>
            </div>
        </div>
    </div>

   <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- PWA Install Logic ---
            let deferredPrompt;
            const loginInstallBtn = document.getElementById('loginInstallBtn');
            const mainInstallBtn = document.getElementById('installAppBtn');
            const iosSheet = document.getElementById('iosSheet');
            const closeIosBtn = document.getElementById('closeIos');
            const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

            const updateInstallButtons = (isEligible) => {
                const buttons = [loginInstallBtn, mainInstallBtn].filter(btn => btn); 

                if (isStandalone) {
                    buttons.forEach(btn => {
                        btn.hidden = true;
                        if (btn.id === 'installAppBtn') {
                            btn.disabled = true;
                            btn.textContent = "Installed";
                        }
                    });
                    return;
                }
                
                if (isIOS || isEligible) {
                    buttons.forEach(btn => {
                        btn.hidden = false;
                        if (btn.id === 'installAppBtn') btn.disabled = false;
                    });
                } else {
                    buttons.forEach(btn => {
                        btn.hidden = true;
                        if (btn.id === 'installAppBtn') btn.disabled = true;
                    });
                }
            };
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                updateInstallButtons(true);
            });
            
            const handleInstallClick = async () => {
                if (isIOS) {
                    if (iosSheet) iosSheet.classList.add('open');
                    return;
                }
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                }
                deferredPrompt = null;
                updateInstallButtons(false);
            };

            if (loginInstallBtn) {
                loginInstallBtn.addEventListener('click', handleInstallClick);
            }
            if (mainInstallBtn) {
                mainInstallBtn.addEventListener('click', handleInstallClick);
            }
            if (closeIosBtn) {
                closeIosBtn.addEventListener('click', () => iosSheet.classList.remove('open'));
            }
            if (iosSheet) {
                iosSheet.addEventListener('click', (e) => {
                    if (e.target === iosSheet) iosSheet.classList.remove('open');
                });
            }

            updateInstallButtons(false); 
            if (isIOS && !isStandalone) {
                updateInstallButtons(true);
            }
            
            window.addEventListener('appinstalled', () => {
                console.log('App installed');
                deferredPrompt = null;
                updateInstallButtons(false); 
            });

            // --- LOGIN AUTHENTICATION LOGIC ---
            const loginScreen = document.getElementById('login-screen');
            const mainContent = document.getElementById('main-content');
            const loginForm = document.getElementById('loginForm');
            const passwordEl = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const statusEl = document.getElementById('status');
            const showPwEl = document.getElementById('showPw');

            const CORRECT_PASSWORD = 'anirvana';

            if (showPwEl && passwordEl) {
                showPwEl.addEventListener('change', (e) => {
                    passwordEl.type = e.target.checked ? 'text' : 'password';
                });
            }

            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (statusEl) {
                        statusEl.textContent = '';
                        statusEl.className = 'status';
                    }

                    const password = passwordEl ? passwordEl.value.trim() : '';

                    if (password === CORRECT_PASSWORD) {
                        if (statusEl) {
                            statusEl.textContent = 'Login successful! Loading app...';
                            statusEl.classList.add('ok');
                        }
                        
                        setTimeout(() => {
                            if (loginScreen) loginScreen.classList.add('hidden');
                            if (mainContent) mainContent.classList.remove('hidden');
                            initializeBillingApp(); 
                        }, 500); 

                    } else {
                        if (statusEl) {
                            statusEl.textContent = 'Incorrect password. Please try again.';
                            statusEl.classList.add('err');
                        }
                        if (passwordEl) {
                            passwordEl.value = '';
                            passwordEl.focus();
                        }
                    }
                });
            }
            
            
            // --- MAIN BILLING APP LOGIC ---
            function initializeBillingApp() {
                
                // --- BOOK DATABASE ---
                const booksDB = [
                    { id: 'default', title: 'Select a Book...', author: '', rate: 0 },
                    { id: '1', title: 'Shrimad Bhagavat Gita, Chapter-5', author: 'Paramahamsa Prajnanananda', rate: 50.00 },
                ];

                // --- STATE ---
                let billItems = [];
                let salesLogDatabase = [];
                let invoiceCounter = 1;

                // --- STORAGE KEYS ---
                const LOG_STORAGE_KEY = 'pm_billbook_sales_log_v1';
                const INVOICE_COUNTER_KEY = 'pm_billbook_invoice_counter_v1';
                const INVOICE_DATE_KEY = 'pm_billbook_invoice_date_v1';

                // --- DOM ELEMENTS ---
                const bookSelectEl = document.getElementById('bookSelect');
                const quantityEl = document.getElementById('quantity');
                const rateEl = document.getElementById('rate');
                const addItemBtn = document.getElementById('addItemBtn');
                const customerNameEl = document.getElementById('customerName');
                const customerAddressEl = document.getElementById('customerAddress');
                const countryCodeEl = document.getElementById('countryCode');
                const whatsappNumberEl = document.getElementById('whatsappNumber');
                const amountPaidEl = document.getElementById('amountPaid');
                const printBtn = document.getElementById('printBtn');
                const downloadLogBtn = document.getElementById('downloadLogBtn');
                const invoiceCustomerNameEl = document.getElementById('invoiceCustomerName');
                const invoiceNumberEl = document.getElementById('invoiceNumber');
                const invoiceDateEl = document.getElementById('invoiceDate');
                const invoiceItemsEl = document.getElementById('invoiceItems');
                const totalEl = document.getElementById('total');
                const paidAmountDisplayEl = document.getElementById('paidAmountDisplay');
                const dueAmountEl = document.getElementById('dueAmount');
                const invoiceAddrBlock = document.getElementById('invoiceAddrBlock');
                const invoiceAddressEl = document.getElementById('invoiceAddress');
                const invoiceContactBlock = document.getElementById('invoiceContactBlock');
                const invoiceContactEl = document.getElementById('invoiceContact');

                // --- UTILS ---
                const populateBookDropdown = () => {
                    booksDB.forEach(book => {
                        const option = document.createElement('option');
                        option.value = book.id;
                        option.textContent = book.title;
                        bookSelectEl.appendChild(option);
                    });
                };

                const handleBookSelection = () => {
                    const selectedBookId = bookSelectEl.value;
                    const selectedBook = booksDB.find(book => book.id === selectedBookId);
                    rateEl.value = selectedBook ? selectedBook.rate.toFixed(2) : '0.00';
                };

                const formatCurrency = (amount) => `₹ ${amount.toFixed(2)}`;

                const getFormattedDate = () => {
                    const today = new Date();
                    const d = String(today.getDate()).padStart(2, '0');
                    const m = String(today.getMonth() + 1).padStart(2, '0');
                    const y = today.getFullYear();
                    return `${d}/${m}/${y}`;
                };

                const getTodayId = () => {
                    const t = new Date();
                    return `${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}`;
                };
                
                const getInvoiceNumber = () => {
                    const today = new Date();
                    const d = String(today.getDate()).padStart(2, '0');
                    const m = String(today.getMonth() + 1).padStart(2, '0');
                    const y = today.getFullYear();
                    const count = String(invoiceCounter).padStart(3, '0');
                    return `INV-${y}${m}${d}-${count}`;
                };

                const getDisplayPhone = () => {
                    const code = (countryCodeEl.value || '').replace(/[^\d]/g, '');
                    const num = (whatsappNumberEl.value || '').replace(/[^\d]/g, '');
                    if (!num) return '';
                    return `+${code || '91'} ${num}`;
                };

                // --- PERSISTENCE HELPERS ---
                const persistSalesLog = () => {
                    try { localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(salesLogDatabase)); }
                    catch (e) { console.warn('Could not persist sales log:', e); }
                };

                const loadSalesLog = () => {
                    try {
                        const raw = localStorage.getItem(LOG_STORAGE_KEY);
                        salesLogDatabase = raw ? JSON.parse(raw) : [];
                    } catch (e) {
                        console.warn('Could not load sales log:', e);
                        salesLogDatabase = [];
                    }
                };

                const loadInvoiceCounter = () => {
                    const todayId = getTodayId();
                    const storedDate = localStorage.getItem(INVOICE_DATE_KEY);
                    if (storedDate === todayId) {
                        const storedCounter = parseInt(localStorage.getItem(INVOICE_COUNTER_KEY) || '1', 10);
                        invoiceCounter = isNaN(storedCounter) ? 1 : storedCounter;
                    } else {
                        invoiceCounter = 1;
                        localStorage.setItem(INVOICE_DATE_KEY, todayId);
                        localStorage.setItem(INVOICE_COUNTER_KEY, String(invoiceCounter));
                    }
                };

                // --- RENDER ---
                const renderBill = () => {
                    invoiceItemsEl.innerHTML = '';
                    const emptyMessageContent = `<tr id="empty-message"><td colspan="6" class="text-center p-16 text-gray-400">Your bill is empty.</td></tr>`;

                    if (billItems.length === 0) {
                        invoiceItemsEl.innerHTML = emptyMessageContent;
                    } else {
                        billItems.forEach((item, index) => {
                            const tr = document.createElement('tr');
                            tr.className = "text-sm text-gray-700";
                            tr.innerHTML = `
                                <td class="p-3">${index + 1}</td>
                                <td class="p-3">
                                    <span class="font-semibold">${item.title}</span>
                                    <span class="block text-xs text-gray-500">${item.author}</span>
                                </td>
                                <td class="p-3 text-center">${item.qty}</td>
                                <td class="p-3 text-right">${formatCurrency(item.rate)}</td>
                                <td class.p-3 text-right font-semibold">${formatCurrency(item.amount)}</td>
                                <td class="p-3 text-center no-print">
                                    <button class="delete-item-btn text-red-500 hover:text-red-700" data-index="${index}" aria-label="Delete item ${index + 1}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </td>
                            `;
                            invoiceItemsEl.appendChild(tr);
                        });
                    }

                    const total = billItems.reduce((acc, item) => acc + item.amount, 0);
                    const paidAmount = parseFloat(amountPaidEl.value) || 0;
                    const dueAmount = total - paidAmount;
                    
                    totalEl.textContent = formatCurrency(total);
                    paidAmountDisplayEl.textContent = formatCurrency(paidAmount);
                    dueAmountEl.textContent = formatCurrency(dueAmount);
                    
                    invoiceCustomerNameEl.textContent = customerNameEl.value || 'Walk-in Customer';
                    const addr = (customerAddressEl.value || '').trim();
                    const phoneDisp = getDisplayPhone();
                    invoiceAddressEl.textContent = addr;
                    invoiceAddrBlock.classList.toggle('hidden', !addr);
                    invoiceContactEl.textContent = phoneDisp;
                    invoiceContactBlock.classList.toggle('hidden', !phoneDisp);
                };

                // --- HANDLERS ---
                const handleAddItem = () => {
                    const selectedBookId = bookSelectEl.value;
                    const selectedBook = booksDB.find(book => book.id === selectedBookId);
                    const qty = parseInt(quantityEl.value, 10);
                    const rate = parseFloat(rateEl.value);

                    if (!selectedBook || selectedBook.id === 'default' || isNaN(qty) || qty <= 0) {
                        alert('Please select a book and enter a valid quantity.');
                        return;
                    }

                    billItems.push({
                        title: selectedBook.title,
                        author: selectedBook.author,
                        qty,
                        rate,
                        amount: qty * rate
                    });

                    bookSelectEl.value = 'default';
                    quantityEl.value = '1';
                    rateEl.value = '0.00';
                    
                    renderBill();
                };

                const handleSaveLog = () => {
                    if (billItems.length === 0) return;

                    const invoiceNo = invoiceNumberEl.textContent;
                    const date = invoiceDateEl.textContent;
                    const customer = customerNameEl.value || 'Walk-in Customer';
                    
                    const total = billItems.reduce((acc, item) => acc + item.amount, 0);
                    const paid = parseFloat(amountPaidEl.value) || 0;
                    const due = total - paid;

                    billItems.forEach((item, index) => {
                        salesLogDatabase.push({
                            invoiceNo,
                            date,
                            customer,
                            itemNo: index + 1,
                            title: item.title,
                            author: item.author,
                            qty: item.qty,
                            rate: item.rate,
                            amount: item.amount,
                            total,
                            paidAmount: paid,
                            dueAmount: due
                        });
                    });
                    persistSalesLog();
                    console.log(`Invoice ${invoiceNo} saved to log. Log entries: ${salesLogDatabase.length}`);
                };

                const handleDownloadFullLog = () => {
                    if (salesLogDatabase.length === 0) {
                        alert('The sales log is empty. Save an invoice first by printing it.');
                        return;
                    }

                    const data = [
                        ["Invoice No", "Date", "Customer", "#", "Book Title", "Author", "Qty", "Rate (₹)", "Amount (₹)", "Invoice Total", "Paid Amount", "Due Amount"]
                    ];

                    salesLogDatabase.forEach(entry => {
                        data.push([
                            entry.invoiceNo,
                            entry.date,
                            entry.customer,
                            entry.itemNo,
                            entry.title,
                            entry.author,
                            entry.qty,
                            entry.rate.toFixed(2),
                            entry.amount.toFixed(2),
                            entry.total.toFixed(2),
                            entry.paidAmount.toFixed(2),
                            entry.dueAmount.toFixed(2)
                        ]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "SalesLog");

                    const today = new Date();
                    const d = String(today.getDate()).padStart(2, '0');
                    const m = String(today.getMonth() + 1).padStart(2, '0');
                    const y = today.getFullYear();
                    const filename = `PrajnanaMission_SalesLog_${y}${m}${d}.xlsx`;
                    
                    XLSX.writeFile(wb, filename);
                };

                // --- WhatsApp helpers ---
                const buildWhatsAppMessage = () => {
                    const invoiceNo = invoiceNumberEl.textContent.trim();
                    const date = invoiceDateEl.textContent.trim();
                    const customer = (customerNameEl.value || 'Walk-in Customer').trim();
                    const address = (customerAddressEl.value || '').trim();
                    const contact = getDisplayPhone();

                    const itemsLines = billItems.map((item, i) => {
                        const authorPart = item.author ? ` (${item.author})` : '';
                        return `${i + 1}) ${item.title}${authorPart} - ${item.qty} x ₹${item.rate.toFixed(2)} = ₹${item.amount.toFixed(2)}`;
                    }).join('\n');

                    const total = billItems.reduce((acc, item) => acc + item.amount, 0);
                    const paid = parseFloat(amountPaidEl.value) || 0;
                    const due = total - paid;

                    return `Prajnana Mission Invoice
Invoice No: ${invoiceNo}
Date: ${date}
Customer: ${customer}${address ? `\nAddress: ${address}` : ''}${contact ? `\nContact: ${contact}` : ''}

Items:
${itemsLines || '-'}
-----------------------
Total: ₹${total.toFixed(2)}
Paid: ₹${paid.toFixed(2)}
Due: ₹${due.toFixed(2)}

Thank you for your support.`;
                };

                const getWhatsAppPhone = () => {
                    const code = (countryCodeEl.value || '').replace(/[^\d]/g, '');
                    const num = (whatsappNumberEl.value || '').replace(/[^\d]/g, '');
                    if (!num) return '';
                    const finalCode = code || '91';
                    return `${finalCode}${num}`;
                };

                const buildWhatsAppURL = (phone, msg) => {
                    const enc = encodeURIComponent(msg);
                    if (phone) return `https://wa.me/${phone}?text=${enc}`;
                    return `https://wa.me/?text=${enc}`;
                };

                const openWhatsAppSafely = (url, waWinHandle) => {
                    try {
                        if (waWinHandle && !waWinHandle.closed) {
                            waWinHandle.location = url;
                        } else {
                            window.open(url, '_blank');
                        }
                    } catch (e) {
                        console.warn('Fallback open due to popup restriction:', e);
                        window.open(url, '_blank');
                    }
                };

                const initialize = () => {
                    loadInvoiceCounter();
                    invoiceDateEl.textContent = getFormattedDate();
                    invoiceNumberEl.textContent = getInvoiceNumber();
                };

                // --- EVENT LISTENERS ---
                if(addItemBtn) addItemBtn.addEventListener('click', handleAddItem);
                if(downloadLogBtn) downloadLogBtn.addEventListener('click', handleDownloadFullLog);
                if(bookSelectEl) bookSelectEl.addEventListener('change', handleBookSelection);

                if(customerNameEl) customerNameEl.addEventListener('input', renderBill);
                if(customerAddressEl) customerAddressEl.addEventListener('input', renderBill);
                if(countryCodeEl) countryCodeEl.addEventListener('input', renderBill);
                if(whatsappNumberEl) whatsappNumberEl.addEventListener('input', renderBill);
                if(amountPaidEl) amountPaidEl.addEventListener('input', renderBill);
                
                if(invoiceItemsEl) invoiceItemsEl.addEventListener('click', (e) => {
                    const deleteButton = e.target.closest('.delete-item-btn');
                    if (deleteButton) {
                        const indexToDelete = parseInt(deleteButton.dataset.index, 10);
                        billItems.splice(indexToDelete, 1);
                        renderBill();
                    }
                });

                // ***** THIS IS THE FIX *****
                // The logic for the print button has been re-ordered.
                if(printBtn) printBtn.addEventListener('click', () => {
                    if (billItems.length === 0) {
                        alert('Your bill is empty. Please add items before printing/sending.');
                        return;
                    }

                    // 1. Save log
                    handleSaveLog();

                    // 2. Prepare WhatsApp info
                    const phone = getWhatsAppPhone();
                    const msg = buildWhatsAppMessage();
                    const waUrl = buildWhatsAppURL(phone, msg);

                    // 3. Set up the 'afterprint' event to open WhatsApp
                    let sentAlready = false;
                    const doSend = () => {
                        if (sentAlready) return;
                        sentAlready = true;
                        window.removeEventListener('afterprint', doSend);
                        
                        // 4. Try to open WhatsApp *after* printing
                        try {
                            window.open(waUrl, '_blank');
                        } catch (e) {
                            console.warn('Could not open WhatsApp tab, possibly blocked.', e);
                        }
                    };

                    window.addEventListener('afterprint', doSend);
                    
                    // 5. Call print() *before* trying to open the popup.
                    window.print();
                    
                    // 6. Fallback timer
                    setTimeout(doSend, 1500);
                });
                // ***** END OF FIX *****

                // --- INITIALIZATION ---
                loadSalesLog();
                if(bookSelectEl) populateBookDropdown();
                initialize();
                renderBill();
            
            } // --- End of initializeBillingApp() function ---
            
        });
    </script>